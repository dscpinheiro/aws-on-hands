Parameters:
  InstanceType:
    Type: String
    Default: t2.small
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
  KeyPair:
    Description: Key pair to connect to the instances
    Type: AWS::EC2::KeyPair::KeyName
  SSHLocation:
    Description: Ip address allowed to SSH into the instances
    Type: String
    MinLength: 9
    MaxLength: 18
    Default: "0.0.0.0/0"
    AllowedPattern: "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x

Resources:
  MyApplication:
    Type: AWS::ElasticBeanstalk::Application
    Properties:
      ApplicationName: MyApplication
      ResourceLifecycleConfig:
        ServiceRole: !Join ["", ["arn:aws:iam::", !Ref "AWS::AccountId", ":role/aws-elasticbeanstalk-service-role"]]
        VersionLifecycleConfig:
          MaxCountRule:
            DeleteSourceFromS3: true
            Enabled: true
            MaxCount: 5

  AccessLogS3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain

  MyEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref MyApplication
      EnvironmentName: MyEnvironment
      # https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html
      OptionSettings:
        - Namespace: "aws:autoscaling:asg"
          OptionName: MinSize
          Value: 1
        - Namespace: "aws:autoscaling:asg"
          OptionName: MaxSize
          Value: 3
        - Namespace: "aws:autoscaling:launchconfiguration"
          OptionName: IamInstanceProfile
          Value: !Join ["", ["arn:aws:iam::", !Ref "AWS::AccountId", ":instance-profile/aws-elasticbeanstalk-ec2-role"]]
        - Namespace: "aws:autoscaling:launchconfiguration"
          OptionName: InstanceType
          Value: !Ref InstanceType
        - Namespace: "aws:autoscaling:launchconfiguration"
          OptionName: EC2KeyName
          Value: !Ref KeyPair
        - Namespace: "aws:autoscaling:launchconfiguration"
          OptionName: SSHSourceRestriction
          Value: !Join [",", ["tcp", "22", "22", !Ref SSHLocation]]
        - Namespace: "aws:elasticbeanstalk:application"
          OptionName: Application Healthcheck URL
          Value: /hc
        - Namespace: "aws:elasticbeanstalk:cloudwatch:logs"
          OptionName: StreamLogs
          Value: true
        - Namespace: "aws:elasticbeanstalk:cloudwatch:logs"
          OptionName: DeleteOnTerminate
          Value: true
        - Namespace: "aws:elasticbeanstalk:environment"
          OptionName: ServiceRole
          Value: !Join ["", ["arn:aws:iam::", !Ref "AWS::AccountId", ":role/aws-elasticbeanstalk-service-role"]]
        - Namespace: "aws:elasticbeanstalk:environment"
          OptionName: EnvironmentType
          Value: LoadBalanced
        - Namespace: "aws:elasticbeanstalk:environment"
          OptionName: LoadBalancerType
          Value: application
        - Namespace: "aws:elasticbeanstalk:environment:process:default"
          OptionName: HealthCheckPath
          Value: /hc
        - Namespace: "aws:elasticbeanstalk:environment:process:default"
          OptionName: HealthyThresholdCount
          Value: 2
        - Namespace: "aws:elasticbeanstalk:environment:process:default"
          OptionName: UnhealthyThresholdCount
          Value: 2
        - Namespace: "aws:elasticbeanstalk:healthreporting:system"
          OptionName: SystemType
          Value: enhanced
        - Namespace: "aws:elasticbeanstalk:managedactions"
          OptionName: ManagedActionsEnabled
          Value: true
        - Namespace: "aws:elasticbeanstalk:managedactions"
          OptionName: PreferredStartTime
          Value: "Tue:22:00"
        - Namespace: "aws:elasticbeanstalk:managedactions:platformupdate"
          OptionName: UpdateLevel
          Value: minor
        - Namespace: "aws:elbv2:loadbalancer"
          OptionName: AccessLogsS3Bucket
          Value: !Ref AccessLogS3Bucket
        - Namespace: "aws:elbv2:loadbalancer"
          OptionName: AccessLogsS3Enabled
          Value: true
      SolutionStackName: 64bit Amazon Linux 2018.03 v2.12.2 running Docker 18.03.1-ce
      Tier:
        Name: WebServer
        Type: Standard

Outputs:
  EndPoint:
    Value: !GetAtt MyEnvironment.EndpointURL
